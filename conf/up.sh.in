#!/bin/bash

. @SYSCONFDIR@/chilli/functions

TUNTAP=$(basename $DEV)
echo $TUNTAP > $RUN_D/tunname

ipt() {
	opt=$1; shift
	echo "iptables -w $opt $*" >> $RUN_D/$TUNTAP-do.sh
	echo "iptables -w -D $*" >> $RUN_D/$TUNTAP-undo.sh
}

run_up() {
	if [[ -n $TUNTAP ]]
	then
		rm -f $RUN_D/$TUNTAP-do.sh $RUN_D/$TUNTAP-undo.sh
		if [[ -n $KNAME ]]
		then
			ifconfig $TUNTAP 0.0.0.0 down
			ipset -q create passthrough hash:ip
			ipset -q flush passthrough

			ipt -A FORWARD -i br0 -t mangle -m comment --comment "'Mark packets LAN->WAN with src address for tc filter'" -j IPMARK --addr=src
			ipt -A FORWARD -o br0 -t mangle -m comment --comment "'Mark packets WAN->LAN with dst address for tc filter'" -j IPMARK --addr=dst
			ipt -A FORWARD -i br0 -m set --match-set passthrough dst -m comment --comment "'Allow LAN->passthrough'" -j ACCEPT
			ipt -A FORWARD -o br0 -m set --match-set passthrough src -m comment --comment "'Allow passthrough->LAN'" -j ACCEPT
			ipt -A FORWARD -i br0 -m coova -m comment --comment "'Allow authenticated clients LAN->WAN'" -j ACCEPT
			ipt -A FORWARD -o br0 -m coova --dest -m comment --comment "'Allow authenticated clients WAN->LAN'" -j ACCEPT
			ipt -A FORWARD -i br0 -t nat -p tcp --dport 80 -m set ! --match-set passthrough dst -m coova ! --checkclient \
				-m comment --comment "'Redirect port 80 for non-passthrough, non-authenticated to UAM'" -j REDIRECT --to-ports $UAMPORT

			ipset add passthrough $ADDR
			for pt in ${HS_UAMALLOW//,/ }; do
				if [[ $pt =~ ([0-9]+\.)+[0-9]+ ]]; then
					ipset -q add passthrough $pt
				else
					for ip in $(host -t a $pt | awk '{ print $4 }'); do
						ipset -q add passthrough $ip
					done
				fi
			done
		else
			ifconfig $TUNTAP txqueuelen 1000
			if type -p tc &> /dev/null; then
				tc qdisc add dev $TUNTAP parent root sfq perturb 10 headdrop
			fi

			if [[ $ONLY8021Q != 1 ]]; then
				ipt -A FORWARD -i $DHCPIF -j DROP
				ipt -A FORWARD -o $DHCPIF -j DROP
			fi

			ipt -I FORWARD -i $TUNTAP -j ACCEPT
			ipt -I FORWARD -o $TUNTAP -j ACCEPT

			# Help out conntrack to not get confused
			# (stops masquerading from working)
			ipt -I PREROUTING -t raw -j NOTRACK -i $DHCPIF
			ipt -I OUTPUT -t raw -j NOTRACK -o $DHCPIF
		fi

		if [[ $HS_LOCAL_DNS == on ]]; then
			ipt -A FORWARD -i br0 -t nat -p udp --dport 53 -m comment --comment "'Rewrite DNS to self'" -j REDIRECT
			ipt -A FORWARD -i br0 -t nat -p tcp --dport 53 -m comment --comment "'Rewrite DNS to self'" -j REDIRECT
		else
			ipt -A FORWARD -i br0 -p udp --dport 53 -j ACCEPT
			ipt -A FORWARD -o br0 -p udp --sport 53 -j ACCEPT
			ipt -A FORWARD -i br0 -p tcp --dport 53 -j ACCEPT
			ipt -A FORWARD -o br0 -p tcp --sport 53 -j ACCEPT
		fi

		ipt -A FORWARD -i br0 -t nat -d $ADDR -p tcp --dport 80 -m comment --comment "'Rewrite packets to self port 80 on LAN to UAM'" -j REDIRECT --to-ports $UAMPORT
	fi
}

run_up
chmod +x $RUN_D/$TUNTAP-do.sh

# flush all tables and set default policy to accept
for table in raw mangle nat filter; do
	iptables -w -t $table -F
	iptables -w -t $table -X

	for chain in INPUT OUTPUT FORWARD PREROUTING POSTROUTING; do
		iptables -w -t $table -P ACCEPT 2>&-
	done
done

$RUN_D/$TUNTAP-do.sh
iptables -w -P FORWARD DROP
